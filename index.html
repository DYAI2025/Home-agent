<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Agent Cockpit ‚Ä¢ Rea<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveKit Agent Avatar Cockpit</title>
    <script src="../client_SDK.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .avatar-container {
            width: 100%;
            height: 500px;
            background-color: #000;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            position: relative;
            overflow: hidden;
        }
        .video-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .readyplayerme-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        input, button, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .chat-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
        }
        .user-message {
            background-color: #d4edda;
        }
        .agent-message {
            background-color: #cce5ff;
        }
        .input-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .input-container input {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>LiveKit Agent Avatar Cockpit</h1>
        
        <div class="controls">
            <input type="text" id="roomInput" placeholder="Room Name" value="avatar-room">
            <input type="text" id="identityInput" placeholder="Your Name" value="user">
            <button onclick="connectToRoom()">Connect to Room</button>
            <button onclick="disconnectFromRoom()">Disconnect</button>
            <select id="avatarModel">
                <option value="">Select Avatar Model</option>
                <option value="https://models.readyplayer.me/66794a1243b679eca39449c7.glb">Default Avatar</option>
                <!-- Add more avatar options here -->
            </select>
            <button onclick="loadAvatar()">Load Avatar</button>
        </div>
        
        <div class="avatar-container" id="avatarContainer">
            <div class="video-container" id="videoContainer">
                <video id="localVideo" autoplay muted playsinline style="display: none;"></video>
                <video id="remoteVideo" autoplay playsinline style="width: 100%; height: 100%;"></video>
            </div>
        </div>
        
        <div class="status" id="status">
            Status: Not connected
        </div>
        
        <div class="chat-container" id="chatContainer">
            <div class="message agent-message">Welcome! Connect to the room to start chatting with the AI agent.</div>
        </div>
        
        <div class="input-container">
            <input type="text" id="messageInput" placeholder="Type your message here...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // LiveKit client
        let room = null;
        let participant = null;
        
        // DOM elements
        const statusDiv = document.getElementById('status');
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        
        // Connect to LiveKit room
        async function connectToRoom() {
            const roomName = document.getElementById('roomInput').value || 'avatar-room';
            const identity = document.getElementById('identityInput').value || 'user';
            
            statusDiv.innerHTML = `Connecting to room: ${roomName}...`;
            
            try {
                // Get access token
                const response = await fetch(`/token?room=${roomName}&identity=${identity}`);
                const { token, url } = await response.json();
                
                // Create room instance
                room = new LiveKit.Room();
                
                // Connect to room
                await room.connect(url, token);
                
                // Local participant
                participant = room.localParticipant;
                
                // Attach local participant's video
                const localVideo = document.getElementById('localVideo');
                const localTrack = participant.videoTrackPublications.get('camera');
                if (localTrack) {
                    localTrack.track.attach(localVideo);
                }
                
                // Handle remote participant tracks
                room.on(LiveKit.RoomEvent.TrackSubscribed, (track, publication, remoteParticipant) => {
                    const remoteVideo = document.getElementById('remoteVideo');
                    track.attach(remoteVideo);
                });
                
                statusDiv.innerHTML = `Connected to room: ${roomName}`;
                
                // Add chat message
                addMessage('system', 'Connected to the room. You can now chat with the AI agent.');
            } catch (error) {
                statusDiv.innerHTML = `Error: ${error.message}`;
                console.error('Connection error:', error);
            }
        }
        
        // Disconnect from room
        function disconnectFromRoom() {
            if (room) {
                room.disconnect();
                room = null;
                statusDiv.innerHTML = 'Disconnected from room';
                addMessage('system', 'Disconnected from the room.');
            }
        }
        
        // Load avatar from Ready Player Me
        function loadAvatar() {
            const avatarModelUrl = document.getElementById('avatarModel').value;
            if (!avatarModelUrl) {
                alert('Please select an avatar model');
                return;
            }
            
            // In a real implementation, you would integrate the avatar model with your 3D engine
            // This is a placeholder to show how it would work
            const avatarContainer = document.getElementById('avatarContainer');
            avatarContainer.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;">ü§ñ</div>
                    <p>Avatar model loaded: ${avatarModelUrl}</p>
                    <p>In a full implementation, this would display your 3D avatar</p>
                </div>
            `;
            
            addMessage('system', 'Avatar loaded. In a full implementation, your Ready Player Me avatar would be displayed here.');
        }
        
        // Send a chat message
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            if (room) {
                // Send data message to other participants
                room.localParticipant.publishData(new TextEncoder().encode(message), 
                    LiveKit.DataPacket_Kind.RELIABLE);
            }
            
            addMessage('user', message);
            messageInput.value = '';
        }
        
        // Add message to chat container
        function addMessage(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(`${sender}-message`);
            
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            
            messageDiv.textContent = `[${timeString}] ${sender.charAt(0).toUpperCase() + sender.slice(1)}: ${text}`;
            chatContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Handle incoming data messages
        function setupDataMessageHandler() {
            if (!room) return;
            
            room.on(LiveKit.RoomEvent.DataReceived, (payload, participant) => {
                const text = new TextDecoder().decode(payload);
                addMessage('agent', text);
            });
        }
        
        // Set up enter key for sending messages
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
dy Player Me</title>
  <style>
    :root{
      --bg0: #0a0b10;
      --bg1: #10121a;
      --glass: rgba(255,255,255,0.06);
      --glass-2: rgba(255,255,255,0.10);
      --txt: #e7ecff;
      --muted: #a9b2d0;
      --accent: #7af1ff;
      --accent-2: #b07cff;
      --danger: #ff6b8a;
      --ok: #79ffa7;
      --shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 0 0 1px rgba(255,255,255,0.06);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0; color:var(--txt); background: radial-gradient(1200px 900px at 10% -10%, #162034 0%, #0b0c12 50%, #06070b 100%), var(--bg0);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      line-height:1.45;
    }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:20px 24px;
      backdrop-filter: saturate(140%) blur(8px);
      background: linear-gradient( to right, rgba(122,241,255,0.06), rgba(176,124,255,0.04) );
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .brand{ font-weight:700; letter-spacing:0.4px; }
    .chip{ padding:6px 10px; border-radius:999px; background:var(--glass); border:1px solid rgba(255,255,255,0.08); color:var(--muted); }
    main{
      display:grid; grid-template-columns: minmax(460px, 1.1fr) minmax(420px, 0.9fr);
      gap:18px; padding:18px; height: calc(100% - 72px);
    }
    .panel{
      background: linear-gradient(180deg, var(--glass-2), var(--glass));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius); box-shadow: var(--shadow);
      padding:16px; display:flex; flex-direction:column; min-height:0;
    }
    .panel h3{ margin:0 0 12px 0; font-size:14px; font-weight:700; text-transform:uppercase; letter-spacing:0.12em; color:var(--muted); }
    .headerline{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      appearance:none; border:none; outline:none; cursor:pointer; text-decoration:none;
      padding:10px 14px; border-radius:12px; background: rgba(255,255,255,0.08);
      color:var(--txt); font-weight:600; letter-spacing:0.2px; box-shadow: var(--shadow);
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      border:1px solid rgba(255,255,255,0.08); display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary{ background: linear-gradient( to right, rgba(122,241,255,0.18), rgba(176,124,255,0.18)); border-color: rgba(122,241,255,0.35); }
    .btn.success{ border-color: rgba(121,255,167,0.35); background: rgba(121,255,167,0.12); }
    .btn.warn{ border-color: rgba(255,107,138,0.35); background: rgba(255,107,138,0.10); }
    .grid-buttons{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; }
    .section{ margin-top:12px; padding-top:12px; border-top:1px dashed rgba(255,255,255,0.08); }
    .kv{ font-size:13px; color:var(--muted); }
    /* Avatar area */
    .viewer-wrap{ position:relative; flex:1; min-height:280px; border-radius:14px; overflow:hidden; border:1px solid rgba(255,255,255,0.08); background:#0b0f18; }
    model-viewer{ width:100%; height:100%; min-height:380px; display:block; }
    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;
    }
    .urlbox{
      margin-top:8px; padding:10px; background:rgba(255,255,255,0.06);
      border-radius:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px;
      word-break: break-all; color:#def7ff; border:1px solid rgba(255,255,255,0.08);
    }
    /* iframe */
    .rpm-frame{ width:100%; height:600px; border:none; border-radius:12px; margin-top:12px; background:#000; }
    /* Switches */
    .switch{
      display:inline-grid; grid-template-columns:auto 1fr; align-items:center; gap:10px; padding:8px 10px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.06); margin:4px 0;
    }
    .switch input{ appearance:none; width:40px; height:24px; border-radius:999px; background:#202637; position:relative; outline:none; border:1px solid rgba(255,255,255,0.12); cursor:pointer; }
    .switch input::after{ content:""; position:absolute; top:2px; left:2px; width:18px; height:18px; border-radius:50%; background:#c6d2ff; transition: all .18s ease; }
    .switch input:checked{ background:linear-gradient( to right, #2be4a2, #7af1ff ); border-color:transparent; }
    .switch input:checked::after{ transform: translateX(16px); background:#0b0f18; }
    .muted{ color:var(--muted); font-size:13px; }
    footer{ padding:10px 18px 18px; color:var(--muted); }
    @media (max-width: 1060px){
      main{ grid-template-columns: 1fr; height:auto; }
      model-viewer{ min-height:320px; }
    }
  </style>
  <!-- 3D Viewer (f√ºr GLB) -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
  <header>
    <div class="brand">AI Agent Cockpit</div>
    <div class="chip">Ready Player Me + Shortcuts</div>
  </header>

  <main>
    <!-- LINKSPANE: Avatar -->
    <section class="panel" id="avatar-panel">
      <div class="headerline">
        <h3>Avatar</h3>
        <div class="row">
          <button class="btn primary" id="btnOpenCreator">Avatar erstellen/√§ndern</button>
          <button class="btn" id="btnHideCreator" title="Creator ausblenden">Creator ausblenden</button>
        </div>
      </div>

      <div class="viewer-wrap">
        <model-viewer id="viewer" src="" alt="Ready Player Me Avatar" camera-controls auto-rotate shadow-intensity="1"></model-viewer>
      </div>
      <div class="toolbar">
        <a class="btn success" id="btnDownloadGlb" href="#" download>GLB speichern</a>
        <button class="btn" id="btnCopyUrl">URL kopieren</button>
      </div>
      <div class="urlbox" id="avatarUrl">Avatar URL: ‚Äì</div>

      <iframe id="rpmFrame" class="rpm-frame" allow="camera *; microphone *; clipboard-write" hidden></iframe>
      <div class="muted section">
        Hinweis: Wenn du eine eigene RPM-Subdomain hast, trage sie unten in <code>CONFIG.subdomain</code> ein (statt <code>demo</code>).
      </div>
    </section>

    <!-- RECHTSPANE: Cockpit -->
    <section class="panel" id="cockpit">
      <div class="headerline">
        <h3>Cockpit</h3>
        <div class="chip" id="bridgeStatus">Bridge: <strong>aus</strong></div>
      </div>

      <div class="section">
        <h3>Schnellstart</h3>
        <div class="grid-buttons">
          <!-- Deeplinks (Zero-Setup) -->
          <a class="btn" data-proto="vscode" data-path="/ABSOLUTER/PFAD/ZU/PROJEKT">üßë‚Äçüíª VS Code ‚Äì Projekt</a>
          <a class="btn" data-proto="cursor" data-path="/ABSOLUTER/PFAD/ZU/PROJEKT">ü§ñ Cursor ‚Äì Projekt</a>
          <a class="btn" href="file:///ABSOLUTER/PFAD/ZU/VERZEICHNIS">üìÅ Ordner √∂ffnen (file://)</a>
          <a class="btn" href="https://console.cloud.google.com/">‚òÅÔ∏è Google Cloud Console</a>

          <!-- Via Bridge (wenn aktiv) -->
          <a class="btn" data-bridge='{"cmd":"code","args":["/ABSOLUTER/PFAD/ZU/PROJEKT"]}'>‚ñ∂Ô∏è √ñffne VS Code (Bridge)</a>
          <a class="btn" data-bridge='{"cmd":"cursor","args":["/ABSOLUTER/PFAD/ZU/PROJEKT"]}'>‚ñ∂Ô∏è √ñffne Cursor (Bridge)</a>
        </div>
      </div>

      <div class="section">
        <h3>Services</h3>
        <label class="switch">
          <input type="checkbox" data-bridge='{"service":"livekit","on":{"cmd":"livekit-start"},"off":{"cmd":"livekit-stop"}}'>
          <span></span> <strong>LiveKit</strong> <span class="muted">lokal starten/stoppen</span>
        </label>
        <label class="switch">
          <input type="checkbox" data-bridge='{"service":"stt","on":{"cmd":"stt-start"},"off":{"cmd":"stt-stop"}}'>
          <span></span> <strong>Speech-to-Text</strong>
        </label>
        <label class="switch">
          <input type="checkbox" data-bridge='{"service":"tts","on":{"cmd":"tts-start"},"off":{"cmd":"tts-stop"}}'>
          <span></span> <strong>Text-to-Speech</strong>
        </label>
      </div>

      <div class="section">
        <h3>Notizen</h3>
        <div class="kv">
          ‚Ä¢ Deeplinks funktionieren nur, wenn die App eine URL-Scheme registriert hat (z. B. <code>vscode://</code>).<br/>
          ‚Ä¢ <code>file://</code>-Links werden von manchen Browsern blockiert, wenn die Seite per <code>http://</code> ausgeliefert wird. Lokal per <code>file://</code> √∂ffnen klappt eher.<br/>
          ‚Ä¢ F√ºr verl√§ssliche Steuerung nutze die Bridge (siehe unten).
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="kv">Konfiguration anpassen in <code>CONFIG</code>. F√ºr die Bridge siehe <em>server.js</em> unten.</div>
  </footer>

  <script>
    // ===================== CONFIG =====================
    const CONFIG = {
      subdomain: 'demo', // <‚Äî HIER deine ReadyPlayerMe-Subdomain eintragen, falls vorhanden
      deeplinks: {
        // Pfade OS-abh√§ngig absolut angeben (z.B. C:/User/‚Ä¶ auf Windows, /Users/‚Ä¶ auf macOS/Linux)
        vscode: (path) => `vscode://file/${encodeURI(path)}`,
        // Cursor Editor (falls registriertes Scheme vorhanden; sonst √ºber Bridge starten)
        cursor: (path) => `cursor://file/${encodeURI(path)}`
      },
      bridge: {
        enabled: true,              // auf false, wenn du die Node-Bridge nicht nutzen willst
        url: 'http://localhost:7071'
      }
    };
    // ==================================================

    // Ready Player Me ‚Äì iFrame initialisieren
    const frame = document.getElementById('rpmFrame');
    frame.src = `https://${CONFIG.subdomain}.readyplayer.me/avatar?frameApi`;

    function safeJSON(x){ try{ return typeof x === 'string' ? JSON.parse(x) : x }catch(_){ return null } }

    function subscribe(event){
      const json = safeJSON(event.data);
      if (!json || json.source !== 'readyplayerme') return;

      if (json.eventName === 'v1.frame.ready') {
        frame.contentWindow.postMessage(JSON.stringify({
          target: 'readyplayerme', type:'subscribe', eventName: 'v1.**'
        }), '*');
      }

      if (json.eventName === 'v1.avatar.exported') {
        const url = json.data.url;
        setViewer(url);
        document.getElementById('avatarUrl').textContent = `Avatar URL: ${url}`;
        const dl = document.getElementById('btnDownloadGlb'); dl.href = url;
        frame.hidden = true;
      }

      if (json.eventName === 'v1.user.set') {
        console.log(`RPM user id: ${json.data.id}`);
      }
    }
    window.addEventListener('message', subscribe);
    document.addEventListener('message', subscribe);

    // 3D Anzeige
    function setViewer(glbUrl){
      const mv = document.getElementById('viewer');
      mv.src = glbUrl;
    }

    // UI-Buttons
    document.getElementById('btnOpenCreator').addEventListener('click', () => frame.hidden = false);
    document.getElementById('btnHideCreator').addEventListener('click', () => frame.hidden = true);
    document.getElementById('btnCopyUrl').addEventListener('click', async () => {
      const txt = document.getElementById('avatarUrl').textContent.replace('Avatar URL: ','').trim();
      if (txt && txt !== '‚Äì') try{ await navigator.clipboard.writeText(txt) }catch(e){ console.warn('Clipboard', e) }
    });

    // Deeplink-Buttons
    function tryOpenURL(url){
      const a = document.createElement('a'); a.href = url; document.body.appendChild(a); a.click();
      setTimeout(() => a.remove(), 100);
    }
    document.querySelectorAll('[data-proto]').forEach(el => {
      el.addEventListener('click', e => {
        e.preventDefault();
        const proto = el.dataset.proto;
        const path = el.dataset.path || '';
        const make = CONFIG.deeplinks[proto];
        if (typeof make === 'function') tryOpenURL(make(path));
      });
    });

    // Bridge-Helfer
    const bridgeChip = document.getElementById('bridgeStatus');
    async function pingBridge(){
      if (!CONFIG.bridge.enabled) { bridgeChip.innerHTML = 'Bridge: <strong>aus</strong>'; return false; }
      try{
        const r = await fetch(CONFIG.bridge.url + '/ping', { method:'GET' });
        if (r.ok){ bridgeChip.innerHTML = 'Bridge: <strong>an</strong>'; return true; }
      }catch(_){}
      bridgeChip.innerHTML = 'Bridge: <strong>aus</strong>';
      return false;
    }
    pingBridge(); // Status initial

    async function callBridge(endpoint, payload){
      if (!CONFIG.bridge.enabled) return;
      try{
        const r = await fetch(CONFIG.bridge.url + endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload || {})
        });
        await r.json().catch(()=> ({}));
      }catch(e){
        console.warn('Bridge nicht erreichbar?', e);
      }finally{
        pingBridge();
      }
    }

    // Bridge-Buttons (sofortige Aktionen)
    document.querySelectorAll('[data-bridge]').forEach(el => {
      el.addEventListener('click', e => {
        e.preventDefault();
        const data = safeJSON(el.dataset.bridge);
        if (!data) return;
        callBridge('/run', data);
      });
    });

    // Bridge-Switches (on/off Services)
    document.querySelectorAll('input[type="checkbox"][data-bridge]').forEach(input => {
      input.addEventListener('change', () => {
        const payload = safeJSON(input.dataset.bridge);
        if (!payload) return;
        const cfg = input.checked ? payload.on : payload.off;
        callBridge('/run', cfg);
      });
    });
  </script>
</body>
</html>

